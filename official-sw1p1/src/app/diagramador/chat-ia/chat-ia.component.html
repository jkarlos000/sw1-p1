<!-- Chat IA Component Template -->
<div class="chat-ia-container" [ngClass]="{ 'chat-abierto': chatAbierto(), 'chat-cerrado': !chatAbierto() }">
  <!-- Botón flotante para abrir/cerrar chat -->
  <button 
    class="chat-toggle-btn" 
    (click)="toggleChat()"
    [title]="chatAbierto() ? 'Cerrar chat' : 'Abrir chat con IA'"
  >
    <svg *ngIf="!chatAbierto()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
    </svg>
    <svg *ngIf="chatAbierto()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
    <!-- Badge de notificación (opcional) -->
    <span class="notification-badge" *ngIf="!chatAbierto() && mensajes().length > 0"></span>
  </button>

  <!-- Panel del chat -->
  <div class="chat-panel" *ngIf="chatAbierto()">
    <!-- Header del chat -->
    <div class="chat-header">
      <div class="chat-header-content">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
        </svg>
        <h3 class="chat-title">Asistente IA</h3>
      </div>
      <button class="chat-close-btn" (click)="toggleChat()" title="Cerrar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
        </svg>
      </button>
    </div>

    <!-- Contenedor de mensajes -->
    <div class="chat-messages-container">
      <!-- Loading state -->
      <div *ngIf="cargando()" class="chat-loading">
        <div class="loading-spinner"></div>
        <p>Cargando conversación...</p>
      </div>

      <!-- Mensajes -->
      <div class="chat-messages" *ngIf="!cargando()">
        <!-- Mensaje vacío -->
        <div *ngIf="mensajes().length === 0" class="mensaje-vacio">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
          </svg>
          <p class="text-gray-500 mt-2">¡Hola! Soy tu asistente de IA.</p>
          <p class="text-gray-400 text-sm mt-1">Puedo ayudarte a crear y modificar tu diagrama UML.</p>
        </div>

        <!-- Lista de mensajes -->
        <div 
          *ngFor="let mensaje of mensajes(); trackBy: trackByMensaje" 
          class="mensaje-item"
          [ngClass]="{
            'mensaje-usuario': mensaje.tipo_mensaje === 'usuario',
            'mensaje-ia': mensaje.tipo_mensaje === 'ia',
            'mensaje-sistema': mensaje.tipo_mensaje === 'sistema'
          }"
        >
          <div class="mensaje-avatar" *ngIf="mensaje.tipo_mensaje === 'ia'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
            </svg>
          </div>

          <div class="mensaje-contenido">
            <div class="mensaje-header" *ngIf="mensaje.tipo_mensaje !== 'sistema'">
              <span class="mensaje-autor">
                {{ mensaje.tipo_mensaje === 'ia' ? 'IA' : (esUsuarioActual(mensaje) ? 'Tú' : mensaje.usuario_email) }}
              </span>
              <span class="mensaje-fecha">{{ formatearFecha(mensaje.fecha_envio) }}</span>
            </div>
            <div class="mensaje-texto" [innerHTML]="mensaje.contenido"></div>
          </div>
        </div>

        <!-- Indicador de IA escribiendo -->
        <div *ngIf="iaEscribiendo()" class="mensaje-item mensaje-ia">
          <div class="mensaje-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
            </svg>
          </div>
          <div class="mensaje-contenido">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>

        <!-- Indicador de usuario escribiendo -->
        <div *ngIf="usuarioEscribiendo()" class="usuario-escribiendo-indicator">
          <span class="text-xs text-gray-500">{{ usuarioEscribiendo() }} está escribiendo...</span>
        </div>
      </div>
    </div>

    <!-- Input de mensaje -->
    <div class="chat-input-container">
      <textarea
        [(ngModel)]="mensajeInput"
        (input)="onInputChange()"
        (keypress)="onKeyPress($event)"
        placeholder="Escribe tu mensaje... (Shift + Enter para nueva línea)"
        class="chat-input"
        rows="1"
      ></textarea>
      <button 
        class="chat-send-btn" 
        (click)="enviarMensaje()"
        [disabled]="!mensajeInput().trim() || !conversacionActual()"
        [title]="mensajeInput().trim() ? 'Enviar mensaje' : 'Escribe un mensaje'"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
        </svg>
      </button>
    </div>
  </div>
</div>
